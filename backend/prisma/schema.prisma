// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 정비사 모델
model Mechanic {
  id          Int      @id @default(autoincrement())
  name        String   // 정비소 이름
  location    String   // 지역명 (예: 강남구, 서초구)
  phone       String   // 전화번호
  description String?  @db.Text // 설명
  address     String   // 상세 주소

  // 지도 좌표 (Decimal 타입으로 정확도 유지)
  mapLat      Decimal  @db.Decimal(10, 8) // 위도
  mapLng      Decimal  @db.Decimal(11, 8) // 경도

  // 이미지
  mainImageUrl    String?  // 대표 이미지 URL
  galleryImages   Json?    // 갤러리 이미지 배열 ["url1", "url2", ...]

  // 유튜브
  youtubeUrl      String?  // 유튜브 숏폼(쇼츠) URL
  youtubeLongUrl  String?  // 유튜브 롱폼(일반 영상) URL

  // 상세 정보
  operatingHours    Json?    // 운영시간 {"mon":{"open":"09:00","close":"18:00"}, ...}
  specialties       Json?    // 전문 분야 ["엔진","미션","판금도색"]
  isVerified        Boolean  @default(false) // YouTube 인증 배지
  parkingAvailable  Boolean? // 주차 가능 여부 (null: 미정)
  paymentMethods    Json?    // 결제 수단 ["현금","카드","카카오페이"]
  holidays          Json?    // 휴무일 {"type":"weekly","days":["sun"],"description":"일요일 휴무"}

  // 통계
  clickCount      Int      @default(0) // 클릭 수

  // 정렬
  sortOrder       Int      @default(0) // 정렬 순서 (낮을수록 먼저 표시)

  // 상태
  isActive        Boolean  @default(true) // 활성화 여부

  // 타임스탬프
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 사장님 연결 (사장님이 직접 등록한 매장)
  ownerId         Int?
  owner           Owner?   @relation(fields: [ownerId], references: [id])

  // 관계
  clickLogs       ClickLog[]
  quoteRequests   QuoteRequest[]
  reviews         Review[]

  // 인덱스
  @@index([location]) // 지역별 검색 최적화
  @@index([isActive])
  @@index([ownerId])
  @@index([sortOrder])
}

// 사장님(Owner) 모델 - 소셜 로그인으로 가입
enum OwnerStatus {
  PENDING   // 가입 신청 (승인 대기)
  APPROVED  // 승인됨
  REJECTED  // 거절됨
}

model Owner {
  id                  Int         @id @default(autoincrement())
  email               String?
  name                String?
  profileImage        String?
  naverId             String?     @unique  // 네이버 고유 ID
  kakaoId             String?     @unique  // 카카오 고유 ID
  provider            String      // "naver" | "kakao"
  status              OwnerStatus @default(PENDING)
  rejectionReason     String?     // 거절 사유
  businessLicenseUrl  String?     // 사업자등록증 이미지 URL
  businessName        String?     // 업체명
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  mechanics           Mechanic[]

  @@index([status])
}

// 관리자 모델
model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   // bcrypt 해시
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 클릭 로그 모델
model ClickLog {
  id         Int      @id @default(autoincrement())
  mechanicId Int
  mechanic   Mechanic @relation(fields: [mechanicId], references: [id], onDelete: Cascade)
  ipAddress  String?  // 클릭한 IP
  userAgent  String?  @db.Text // User-Agent 헤더
  isBot      Boolean  @default(false) // 봇 여부
  clickedAt  DateTime @default(now())

  @@index([mechanicId, clickedAt])
  @@index([ipAddress])
}

// 문의 모델
enum InquiryType {
  CUSTOMER  // 소비자(고객) 문의
  MECHANIC  // 정비사(사장님) 문의
}

model Inquiry {
  id            Int         @id @default(autoincrement())
  type          InquiryType // 문의 유형
  name          String      // 이름 또는 대표자명
  phone         String      // 연락처
  businessName  String?     // 상호명 (정비사 문의 시)
  content       String      @db.Text // 문의 내용
  reply         String?     @db.Text // 답변 내용
  isRead        Boolean     @default(false) // 읽음 여부
  repliedAt     DateTime?   // 답변 일시
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}

// 견적 요청 상태
enum QuoteRequestStatus {
  PENDING    // 접수됨
  VIEWED     // 확인됨
  REPLIED    // 답변됨
  COMPLETED  // 완료
  CANCELLED  // 취소
}

// 견적 요청 모델
model QuoteRequest {
  id            Int                @id @default(autoincrement())
  mechanicId    Int
  mechanic      Mechanic           @relation(fields: [mechanicId], references: [id], onDelete: Cascade)

  // 고객 정보
  customerName  String             // 고객 이름
  customerPhone String             // 고객 연락처
  carModel      String             // 차종 (예: 현대 아반떼 2023)
  carYear       String?            // 연식
  description   String    @db.Text // 증상/요청 내용

  // 사진 첨부
  images        Json?              // ["url1", "url2"] - S3 URLs (최대 3장)

  status        QuoteRequestStatus @default(PENDING)

  // 알림톡 발송 여부
  alimtalkSent    Boolean   @default(false)
  alimtalkSentAt  DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([mechanicId, status])
  @@index([mechanicId, createdAt])
  @@index([status])
}

// 한줄 리뷰 모델
model Review {
  id          Int      @id @default(autoincrement())
  mechanicId  Int
  mechanic    Mechanic @relation(fields: [mechanicId], references: [id], onDelete: Cascade)

  nickname    String              // 닉네임
  content     String   @db.VarChar(100) // 한줄 리뷰 (최대 100자)
  rating      Int      @default(5) // 1-5 별점

  isApproved  Boolean  @default(false) // 관리자 승인 필요
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([mechanicId, isApproved, isActive])
  @@index([createdAt])
}

// 페이지뷰 로그 모델
model PageView {
  id         Int      @id @default(autoincrement())
  path       String   // 페이지 경로
  ipAddress  String?  // 방문자 IP
  userAgent  String?  @db.Text // User-Agent 헤더
  isBot      Boolean  @default(false) // 봇 여부
  referer    String?  // 리퍼러 URL
  viewedAt   DateTime @default(now())

  @@index([path, viewedAt])
  @@index([isBot])
}
