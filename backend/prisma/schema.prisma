// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ì •ë¹„ì‚¬ ëª¨ë¸
model Mechanic {
  id          Int      @id @default(autoincrement())
  name        String   // ì •ë¹„ì†Œ ì´ë¦„
  location    String   // ì§€ì—­ëª… (ì˜ˆ: ê°•ë‚¨êµ¬, ì„œì´ˆêµ¬)
  phone       String   // ì „í™”ë²ˆí˜¸
  description String?  @db.Text // ì„¤ëª…
  address     String   // ìƒì„¸ ì£¼ì†Œ

  // ì§€ë„ ì¢Œí‘œ (Decimal íƒ€ì…ìœ¼ë¡œ ì •í™•ë„ ìœ ì§€)
  mapLat      Decimal  @db.Decimal(10, 8) // ìœ„ë„
  mapLng      Decimal  @db.Decimal(11, 8) // ê²½ë„

  // ì´ë¯¸ì§€
  mainImageUrl    String?  // ëŒ€í‘œ ì´ë¯¸ì§€ URL
  galleryImages   Json?    // ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ë°°ì—´ ["url1", "url2", ...]

  // ìœ íŠœë¸Œ
  youtubeUrl      String?  // ìœ íŠœë¸Œ ìˆí¼(ì‡¼ì¸ ) URL
  youtubeLongUrl  String?  // ìœ íŠœë¸Œ ë¡±í¼(ì¼ë°˜ ì˜ìƒ) URL

  // ìƒì„¸ ì •ë³´
  operatingHours    Json?    // ìš´ì˜ì‹œê°„ {"mon":{"open":"09:00","close":"18:00"}, ...}
  specialties       Json?    // ì „ë¬¸ ë¶„ì•¼ ["ì—”ì§„","ë¯¸ì…˜","íŒê¸ˆë„ìƒ‰"]
  isVerified        Boolean  @default(false) // YouTube ì¸ì¦ ë°°ì§€
  parkingAvailable  Boolean? // ì£¼ì°¨ ê°€ëŠ¥ ì—¬ë¶€ (null: ë¯¸ì •)
  paymentMethods    Json?    // ê²°ì œ ìˆ˜ë‹¨ ["í˜„ê¸ˆ","ì¹´ë“œ","ì¹´ì¹´ì˜¤í˜ì´"]
  holidays          Json?    // íœ´ë¬´ì¼ {"type":"weekly","days":["sun"],"description":"ì¼ìš”ì¼ íœ´ë¬´"}
  kakaoOpenChatUrl  String?  // ì¹´ì¹´ì˜¤ ì˜¤í”ˆì±„íŒ… ë§í¬

  // í†µê³„
  clickCount      Int      @default(0) // í´ë¦­ ìˆ˜

  // ì •ë ¬
  sortOrder       Int      @default(0) // ì •ë ¬ ìˆœì„œ (ë‚®ì„ìˆ˜ë¡ ë¨¼ì € í‘œì‹œ)

  // ìƒíƒœ
  isActive        Boolean  @default(true) // í™œì„±í™” ì—¬ë¶€

  // íƒ€ì„ìŠ¤íƒ¬í”„
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // ì‚¬ì¥ë‹˜ ì—°ê²° (ì‚¬ì¥ë‹˜ì´ ì§ì ‘ ë“±ë¡í•œ ë§¤ì¥)
  ownerId         Int?
  owner           Owner?   @relation(fields: [ownerId], references: [id])

  // ê´€ê³„
  clickLogs       ClickLog[]
  quoteRequests   QuoteRequest[]
  reviews         Review[]

  // ì¸ë±ìŠ¤
  @@index([location]) // ì§€ì—­ë³„ ê²€ìƒ‰ ìµœì í™”
  @@index([isActive])
  @@index([ownerId])
  @@index([sortOrder])
}

// ì‚¬ì¥ë‹˜(Owner) ëª¨ë¸ - ì†Œì…œ ë¡œê·¸ì¸ìœ¼ë¡œ ê°€ì…
enum OwnerStatus {
  PENDING   // ê°€ì… ì‹ ì²­ (ìŠ¹ì¸ ëŒ€ê¸°)
  APPROVED  // ìŠ¹ì¸ë¨
  REJECTED  // ê±°ì ˆë¨
}

model Owner {
  id                  Int         @id @default(autoincrement())
  email               String?
  name                String?
  profileImage        String?
  naverId             String?     @unique  // ë„¤ì´ë²„ ê³ ìœ  ID
  kakaoId             String?     @unique  // ì¹´ì¹´ì˜¤ ê³ ìœ  ID
  provider            String      // "naver" | "kakao"
  status              OwnerStatus @default(APPROVED)
  rejectionReason     String?     // ê±°ì ˆ ì‚¬ìœ 
  businessLicenseUrl  String?     // ì‚¬ì—…ìë“±ë¡ì¦ ì´ë¯¸ì§€ URL
  businessName        String?     // ì—…ì²´ëª…
  phone               String?     // ì•Œë¦¼í†¡ ë°œì†¡ìš© ì „í™”ë²ˆí˜¸
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  mechanics           Mechanic[]

  @@index([status])
}

// ê´€ë¦¬ì ëª¨ë¸
model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   // bcrypt í•´ì‹œ
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// í´ë¦­ ë¡œê·¸ ëª¨ë¸
model ClickLog {
  id         Int      @id @default(autoincrement())
  mechanicId Int
  mechanic   Mechanic @relation(fields: [mechanicId], references: [id], onDelete: Cascade)
  ipAddress  String?  // í´ë¦­í•œ IP
  userAgent  String?  @db.Text // User-Agent í—¤ë”
  isBot      Boolean  @default(false) // ë´‡ ì—¬ë¶€
  clickedAt  DateTime @default(now())

  @@index([mechanicId, clickedAt])
  @@index([ipAddress])
}

// ë¬¸ì˜ ëª¨ë¸
enum InquiryType {
  CUSTOMER  // ì†Œë¹„ì(ê³ ê°) ë¬¸ì˜
  MECHANIC  // ì •ë¹„ì‚¬(ì‚¬ì¥ë‹˜) ë¬¸ì˜
}

model Inquiry {
  id            Int         @id @default(autoincrement())
  type          InquiryType // ë¬¸ì˜ ìœ í˜•
  name          String      // ì´ë¦„ ë˜ëŠ” ëŒ€í‘œìëª…
  phone         String      // ì—°ë½ì²˜
  businessName  String?     // ìƒí˜¸ëª… (ì •ë¹„ì‚¬ ë¬¸ì˜ ì‹œ)
  content       String      @db.Text // ë¬¸ì˜ ë‚´ìš©
  reply         String?     @db.Text // ë‹µë³€ ë‚´ìš©
  isRead        Boolean     @default(false) // ì½ìŒ ì—¬ë¶€
  repliedAt     DateTime?   // ë‹µë³€ ì¼ì‹œ
  createdAt     DateTime    @default(now())
  updatedAt     DateTime    @updatedAt

  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}

// ê²¬ì  ìš”ì²­ ìƒíƒœ
enum QuoteRequestStatus {
  PENDING    // ì ‘ìˆ˜ë¨
  VIEWED     // í™•ì¸ë¨
  REPLIED    // ë‹µë³€ë¨
  COMPLETED  // ì™„ë£Œ
  CANCELLED  // ì·¨ì†Œ
}

// ê²¬ì  ìš”ì²­ ëª¨ë¸
model QuoteRequest {
  id            Int                @id @default(autoincrement())
  mechanicId    Int
  mechanic      Mechanic           @relation(fields: [mechanicId], references: [id], onDelete: Cascade)

  // ê³ ê° ì •ë³´
  customerName  String             // ê³ ê° ì´ë¦„
  customerPhone String             // ê³ ê° ì—°ë½ì²˜
  carModel      String             // ì°¨ì¢… (ì˜ˆ: í˜„ëŒ€ ì•„ë°˜ë–¼ 2023)
  carYear       String?            // ì—°ì‹
  description   String    @db.Text // ì¦ìƒ/ìš”ì²­ ë‚´ìš©

  // ì‚¬ì§„ ì²¨ë¶€
  images        Json?              // ["url1", "url2"] - S3 URLs (ìµœëŒ€ 3ì¥)

  status        QuoteRequestStatus @default(PENDING)

  // ì•Œë¦¼í†¡ ë°œì†¡ ì—¬ë¶€
  alimtalkSent    Boolean   @default(false)
  alimtalkSentAt  DateTime?

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@index([mechanicId, status])
  @@index([mechanicId, createdAt])
  @@index([status])
}

// í•œì¤„ ë¦¬ë·° ëª¨ë¸
model Review {
  id          Int      @id @default(autoincrement())
  mechanicId  Int
  mechanic    Mechanic @relation(fields: [mechanicId], references: [id], onDelete: Cascade)

  nickname    String              // ë‹‰ë„¤ì„
  content     String   @db.VarChar(100) // í•œì¤„ ë¦¬ë·° (ìµœëŒ€ 100ì)
  rating      Int      @default(5) // 1-5 ë³„ì 

  isApproved  Boolean  @default(false) // ê´€ë¦¬ì ìŠ¹ì¸ í•„ìš”
  isActive    Boolean  @default(true)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([mechanicId, isApproved, isActive])
  @@index([createdAt])
}

// í˜ì´ì§€ë·° ë¡œê·¸ ëª¨ë¸
model PageView {
  id         Int      @id @default(autoincrement())
  path       String   // í˜ì´ì§€ ê²½ë¡œ
  ipAddress  String?  // ë°©ë¬¸ì IP
  userAgent  String?  @db.Text // User-Agent í—¤ë”
  isBot      Boolean  @default(false) // ë´‡ ì—¬ë¶€
  referer    String?  // ë¦¬í¼ëŸ¬ URL
  viewedAt   DateTime @default(now())

  @@index([path, viewedAt])
  @@index([isBot])
}

// ========================================
// ğŸ“±ğŸ’» í°-ì»´í“¨í„° ë™ê¸°í™” (Sync) ëª¨ë¸
// ========================================

enum SyncMessageType {
  INSTRUCTION  // ì§€ì‹œ/ëª…ë ¹
  NOTE         // ë©”ëª¨
  LINK         // ë§í¬
  IMAGE        // ì´ë¯¸ì§€
}

enum SyncMessageStatus {
  PENDING      // ëŒ€ê¸°
  IN_PROGRESS  // ì§„í–‰ ì¤‘
  COMPLETED    // ì™„ë£Œ
  CANCELLED    // ì·¨ì†Œ
}

model SyncMessage {
  id          Int               @id @default(autoincrement())
  content     String            @db.Text         // ì§€ì‹œ ë‚´ìš©
  type        SyncMessageType   @default(INSTRUCTION)
  status      SyncMessageStatus @default(PENDING)
  deviceFrom  String            @default("phone") // "phone" | "computer"
  priority    Int               @default(0)       // 0=ë³´í†µ, 1=ë†’ìŒ, 2=ê¸´ê¸‰
  images      Json?             // S3 ì´ë¯¸ì§€ URL ë°°ì—´
  reply       String?           @db.Text          // ë‹µë³€/ë©”ëª¨
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  completedAt DateTime?

  @@index([status])
  @@index([createdAt])
  @@index([deviceFrom])
}

// íƒ€ì´ì–´ ë¬¸ì˜ ìƒíƒœ
enum TireInquiryStatus {
  PENDING      // ì ‘ìˆ˜ë¨
  IN_PROGRESS  // ì²˜ë¦¬ì¤‘ (ê´€ë¦¬ìê°€ ì •ë¹„ì†Œ ì—°ê²° ì¤‘)
  MATCHED      // ì •ë¹„ì†Œ ë§¤ì¹­ë¨
  COMPLETED    // ì™„ë£Œ
  CANCELLED    // ì·¨ì†Œ
}

// íƒ€ì´ì–´ ë¬¸ì˜ ì„œë¹„ìŠ¤ íƒ€ì…
enum TireServiceType {
  REPLACEMENT  // íƒ€ì´ì–´ êµì²´
  REPAIR       // í‘í¬ ìˆ˜ë¦¬
  ALIGNMENT    // ì–¼ë¼ì¸ë¨¼íŠ¸
  INSPECTION   // íƒ€ì´ì–´ ì ê²€
}

// ========================================
// ğŸš— ê³ ê° (Customer) ëª¨ë¸ - Phase 1
// ========================================
model Customer {
  id          Int      @id @default(autoincrement())
  kakaoId     String   @unique  // ì¹´ì¹´ì˜¤ ê³ ìœ  ID
  nickname    String?           // ì¹´ì¹´ì˜¤ ë‹‰ë„¤ì„
  email       String?           // ì¹´ì¹´ì˜¤ ì´ë©”ì¼ (ì„ íƒ)
  phone       String?           // ì§ì ‘ ì…ë ¥ ì „í™”ë²ˆí˜¸ (ë¬¸ì˜ ìƒì„± ì‹œ ì—…ë°ì´íŠ¸)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  serviceInquiries ServiceInquiry[]

  @@index([kakaoId])
  @@index([phone])
}

// ì„œë¹„ìŠ¤ ë¬¸ì˜ íƒ€ì…
enum ServiceType {
  TIRE         // íƒ€ì´ì–´ (êµì²´Â·í‘í¬Â·ìœ„ì¹˜êµí™˜)
  OIL          // ì—”ì§„ì˜¤ì¼ (êµí™˜Â·ë³´ì¶©)
  BRAKE        // ë¸Œë ˆì´í¬ (íŒ¨ë“œÂ·ë””ìŠ¤í¬Â·ì ê²€)
  MAINTENANCE  // ê²½ì •ë¹„ (ì—ì–´ì»¨Â·ë°°í„°ë¦¬Â·ê¸°íƒ€)
  CONSULT      // ì¢…í•©ìƒë‹´ (ë­˜ í•´ì•¼ í• ì§€ ëª¨ë¥¼ ë•Œ)
}

// ì„œë¹„ìŠ¤ ë¬¸ì˜ ìƒíƒœ
enum ServiceInquiryStatus {
  PENDING    // ì ‘ìˆ˜ë¨ (í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡ ì™„ë£Œ)
  SHARED     // ìš´ì˜ìê°€ ë‹¨í†¡ë°©ì— ê³µìœ í•¨
  CONNECTED  // ì •ë¹„ì‚¬-ê³ ê° ì—°ê²°ë¨
  COMPLETED  // ì •ë¹„ ì™„ë£Œ
}

// ========================================
// ğŸ”” ì„œë¹„ìŠ¤ ë¬¸ì˜ ëª¨ë¸ - Phase 1 í•µì‹¬
// ========================================
model ServiceInquiry {
  id            Int                    @id @default(autoincrement())

  // ê³ ê° ì •ë³´
  customerId    Int
  customer      Customer               @relation(fields: [customerId], references: [id])

  // ì§€ì—­ ì •ë³´
  regionSido    String                 // ì‹œ/ë„ (ì˜ˆ: "ê²½ê¸°ë„")
  regionSigungu String                 // ì‹œ/êµ°/êµ¬ (ì˜ˆ: "ìˆ˜ì›ì‹œ")

  // ê³ ê° ì „í™”ë²ˆí˜¸ (ì ‘ìˆ˜ ì‹œì  ê¸°ë¡)
  phone         String?

  // ì„œë¹„ìŠ¤ ì •ë³´
  serviceType   ServiceType            // ì •ë¹„ í•­ëª©
  description   String?   @db.Text    // ì¶”ê°€ ì„¤ëª… (ì„ íƒ)

  // ìƒíƒœ
  status        ServiceInquiryStatus   @default(PENDING)

  // ì¹´ì¹´ì˜¤ ì˜¤í”ˆì±„íŒ… URL
  kakaoOpenChatUrl  String?  // ìš´ì˜ìê°€ ì§€ì •í•œ ì¹´ì¹´ì˜¤ ì˜¤í”ˆì±„íŒ… ë§í¬

  // í…”ë ˆê·¸ë¨ ì•Œë¦¼ ë°œì†¡ ì—¬ë¶€
  telegramSent    Boolean   @default(false)
  telegramSentAt  DateTime?

  createdAt     DateTime               @default(now())
  updatedAt     DateTime               @updatedAt

  @@index([customerId])
  @@index([regionSido, regionSigungu])
  @@index([serviceType])
  @@index([status])
  @@index([createdAt])
}

// íƒ€ì´ì–´ ë¬¸ì˜ ëª¨ë¸
model TireInquiry {
  id            Int                @id @default(autoincrement())

  // ì§€ì—­ ì •ë³´
  region        String             // ì‹œ/ë„ (ì˜ˆ: "ì„œìš¸íŠ¹ë³„ì‹œ")
  subRegion     String?            // ì‹œ/êµ°/êµ¬ (ì˜ˆ: "ê°•ë‚¨êµ¬")

  // íƒ€ì´ì–´ ì •ë³´
  tireSize      String             // íƒ€ì´ì–´ ì‚¬ì´ì¦ˆ (ì˜ˆ: "225/45R17")
  serviceType   TireServiceType    @default(REPLACEMENT)

  // ì°¨ëŸ‰ ì •ë³´ (ì„ íƒ)
  carModel      String?            // ì°¨ì¢…

  // ì‚¬ì§„
  images        Json?              // ["url1", "url2"] - íƒ€ì´ì–´ ì˜†ë©´ ì‚¬ì§„

  // ì¶”ê°€ ì„¤ëª…
  description   String?            @db.Text

  // ìƒíƒœ
  status        TireInquiryStatus  @default(PENDING)

  // ê´€ë¦¬ì ë©”ëª¨
  adminNote     String?            @db.Text

  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([region])
  @@index([status])
  @@index([createdAt])
}
