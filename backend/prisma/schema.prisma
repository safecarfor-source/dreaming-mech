// Prisma Schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 정비사 모델
model Mechanic {
  id          Int      @id @default(autoincrement())
  name        String   // 정비소 이름
  location    String   // 지역명 (예: 강남구, 서초구)
  phone       String   // 전화번호
  description String?  @db.Text // 설명
  address     String   // 상세 주소

  // 지도 좌표 (Decimal 타입으로 정확도 유지)
  mapLat      Decimal  @db.Decimal(10, 8) // 위도
  mapLng      Decimal  @db.Decimal(11, 8) // 경도

  // 이미지
  mainImageUrl    String?  // 대표 이미지 URL
  galleryImages   Json?    // 갤러리 이미지 배열 ["url1", "url2", ...]

  // 유튜브
  youtubeUrl      String?  // 유튜브 숏폼(쇼츠) URL
  youtubeLongUrl  String?  // 유튜브 롱폼(일반 영상) URL

  // 통계
  clickCount      Int      @default(0) // 클릭 수

  // 정렬
  sortOrder       Int      @default(0) // 정렬 순서 (낮을수록 먼저 표시)

  // 상태
  isActive        Boolean  @default(true) // 활성화 여부

  // 타임스탬프
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // 사장님 연결 (사장님이 직접 등록한 매장)
  ownerId         Int?
  owner           Owner?   @relation(fields: [ownerId], references: [id])

  // 관계
  clickLogs       ClickLog[]

  // 인덱스
  @@index([location]) // 지역별 검색 최적화
  @@index([isActive])
  @@index([ownerId])
  @@index([sortOrder])
}

// 사장님(Owner) 모델 - 소셜 로그인으로 가입
enum OwnerStatus {
  PENDING   // 가입 신청 (승인 대기)
  APPROVED  // 승인됨
  REJECTED  // 거절됨
}

model Owner {
  id                  Int         @id @default(autoincrement())
  email               String?
  name                String?
  profileImage        String?
  naverId             String?     @unique  // 네이버 고유 ID
  kakaoId             String?     @unique  // 카카오 고유 ID
  provider            String      // "naver" | "kakao"
  status              OwnerStatus @default(PENDING)
  businessLicenseUrl  String?     // 사업자등록증 이미지 URL
  businessName        String?     // 업체명
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt
  mechanics           Mechanic[]

  @@index([status])
}

// 관리자 모델
model Admin {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String   // bcrypt 해시
  name      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// 클릭 로그 모델
model ClickLog {
  id         Int      @id @default(autoincrement())
  mechanicId Int
  mechanic   Mechanic @relation(fields: [mechanicId], references: [id], onDelete: Cascade)
  ipAddress  String?  // 클릭한 IP
  userAgent  String?  @db.Text // User-Agent 헤더
  isBot      Boolean  @default(false) // 봇 여부
  clickedAt  DateTime @default(now())

  @@index([mechanicId, clickedAt])
  @@index([ipAddress])
}

// 페이지뷰 로그 모델
model PageView {
  id         Int      @id @default(autoincrement())
  path       String   // 페이지 경로
  ipAddress  String?  // 방문자 IP
  userAgent  String?  @db.Text // User-Agent 헤더
  isBot      Boolean  @default(false) // 봇 여부
  referer    String?  // 리퍼러 URL
  viewedAt   DateTime @default(now())

  @@index([path, viewedAt])
  @@index([isBot])
}
