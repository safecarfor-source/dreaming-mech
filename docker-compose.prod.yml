# Production Docker Compose
# 시스템 Nginx가 SSL + 리버스 프록시 처리 (localhost:3000, localhost:3001)

services:
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: dreaming-mech-backend
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      # RDS 또는 외부 PostgreSQL URL
      DATABASE_URL: ${DATABASE_URL}
      JWT_SECRET: ${JWT_SECRET}
      NAVER_MAP_CLIENT_ID: ${NAVER_MAP_CLIENT_ID}
      NAVER_MAP_CLIENT_SECRET: ${NAVER_MAP_CLIENT_SECRET}
      AWS_S3_BUCKET: ${AWS_S3_BUCKET}
      AWS_REGION: ${AWS_REGION:-ap-northeast-2}
      AWS_ACCESS_KEY_ID: ${AWS_ACCESS_KEY_ID}
      AWS_SECRET_ACCESS_KEY: ${AWS_SECRET_ACCESS_KEY}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS}
      # Kakao OAuth
      KAKAO_CLIENT_ID: ${KAKAO_CLIENT_ID}
      KAKAO_CLIENT_SECRET: ${KAKAO_CLIENT_SECRET}
      KAKAO_CALLBACK_URL: ${KAKAO_CALLBACK_URL}
      KAKAO_CUSTOMER_CALLBACK_URL: ${KAKAO_CUSTOMER_CALLBACK_URL}
      FRONTEND_URL: ${FRONTEND_URL}
      # Telegram Bot
      TELEGRAM_BOT_TOKEN: ${TELEGRAM_BOT_TOKEN}
      TELEGRAM_CHAT_ID: ${TELEGRAM_CHAT_ID}
      # SOLAPI 알림톡
      SOLAPI_API_KEY: ${SOLAPI_API_KEY:-}
      SOLAPI_API_SECRET: ${SOLAPI_API_SECRET:-}
      SOLAPI_SENDER_PHONE: ${SOLAPI_SENDER_PHONE:-}
      SOLAPI_KAKAO_CHANNEL_ID: ${SOLAPI_KAKAO_CHANNEL_ID:-}
      SOLAPI_QUOTE_TEMPLATE_ID: ${SOLAPI_QUOTE_TEMPLATE_ID:-}
      SOLAPI_INQUIRY_TEMPLATE_ID: ${SOLAPI_INQUIRY_TEMPLATE_ID:-}
    networks:
      - app-network
    command: sh -c "npx prisma migrate deploy && npm run start:prod"
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3001/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
        NEXT_PUBLIC_NAVER_MAP_CLIENT_ID: ${NEXT_PUBLIC_NAVER_MAP_CLIENT_ID}
    container_name: dreaming-mech-frontend
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL}
      NEXT_PUBLIC_NAVER_MAP_CLIENT_ID: ${NEXT_PUBLIC_NAVER_MAP_CLIENT_ID}
    depends_on:
      backend:
        condition: service_healthy
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "node -e \"require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

networks:
  app-network:
    driver: bridge
